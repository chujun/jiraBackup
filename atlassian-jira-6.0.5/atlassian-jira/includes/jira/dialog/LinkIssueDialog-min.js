JIRA.Dialogs.createLinkIssueDialog=function(){function markSelectedLinkType(activeId,linkTypes){var hasSelected=false;jQuery.each(linkTypes,function(i,linkType){if(linkType.id===activeId){linkType.isSelected=true;hasSelected=true;return false}});if(!hasSelected){linkTypes[0].isSelected=true}return linkTypes}function getRemoteIssueLinks(issueId){var deferred=jQuery.Deferred();JIRA.SmartAjax.makeRequest({url:contextPath+"/rest/viewIssue/1/remoteIssueLink/linkType?issueId="+issueId,complete:function(xhr,textStatus,smartAjaxResult){if(smartAjaxResult.successful){deferred.resolve(smartAjaxResult.data)}else{deferred.reject(JIRA.SmartAjax.buildDialogErrorContent(smartAjaxResult))}}});return deferred.promise()}function getTabContent(dialog){var deferred=jQuery.Deferred(),ajaxOptions=JIRA.Dialogs.getDefaultAjaxOptions.call(dialog);ajaxOptions.complete=function(xhr,textStatus,smartAjaxResult){if(smartAjaxResult.successful){deferred.resolve(smartAjaxResult.data)}else{deferred.reject(JIRA.SmartAjax.buildDialogErrorContent(smartAjaxResult))}};JIRA.SmartAjax.makeRequest(ajaxOptions);return deferred.promise()}function getActiveTabId(dialog){return dialog.$activeTrigger.attr("id")}return function(trigger){return new JIRA.FormDialog({id:"link-issue-dialog",isIssueDialog:true,trigger:trigger,onSuccessfulSubmit:function(data,smartAjaxResponse){if(smartAjaxResponse.getResponseHeader("X-Atlassian-Dialog-Msg-Type")!=="warning"){JIRA.Dialogs.storeCurrentIssueIdOnSucessfulSubmit.apply(this,arguments)}},issueMsg:"thanks_issue_linked",widthClass:"large",stacked:true,content:function(ready){var dialog=this,issueId=JIRA.Issue.getIssueId()||JIRA.IssueNavigator.getSelectedIssueId();getTabContent(dialog).done(function(tabContent){getRemoteIssueLinks(issueId).done(function(linkTypes){linkTypes=markSelectedLinkType(getActiveTabId(dialog),linkTypes);ready(JIRA.Templates.LinkIssue.dialog({linkTypes:linkTypes,tabContent:tabContent}));jQuery.each(linkTypes,function(i,linkType){var focusElementSelector;if(linkType.isSelected===true){focusElementSelector="[name='"+linkType.focusedFieldName+"']";if(jQuery(focusElementSelector).length===0){focusElementSelector="#"+linkType.id}dialog._focusFirstField(focusElementSelector)}})}).fail(function(errorContent){ready(errorContent)})}).fail(function(errorContent){ready(errorContent)})},formatSubmitResponseContent:function(content){this.get$popupContent().find(".dialog-pane").html(content);return this.get$popupContent().html()},onContentRefresh:function(){this.bindAnchorsToDialog(this.get$popupContent().find(".dialog-menu-item "))}})}}();