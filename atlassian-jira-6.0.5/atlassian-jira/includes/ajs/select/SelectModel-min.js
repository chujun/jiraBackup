AJS.SelectModel=AJS.Control.extend({init:function(options){var instance=this;if(options.element){options.element=AJS.$(options.element)}else{options.element=AJS.$(options)}this._setOptions(options);this.$element=this.options.element.hide();this.type=this.$element.attr("multiple")?"multiple":"single";this.id=this.$element.attr("id")||this.$element.attr("name");if(this.type==="single"){this.$element.attr("multiple","multiple")}this.$element.bind("reset",function(){instance._parseDescriptors()});this._parseDescriptors()},_getFreeInputEl:function(){return this.$element.find(".free-input")},removeFreeInputVal:function(){this._getFreeInputEl().remove()},updateFreeInput:function(val){var $freeInput=this._getFreeInputEl();val=AJS.$.trim(val);if(val){if(!$freeInput.length){$freeInput=AJS.$("<option class='free-input' />").appendTo(this.$element)}$freeInput.attr({"value":val,"selected":"selected"})}else{$freeInput.remove()}},_getDefaultOptions:function(){return{}},getSelectedValues:function(){var selectedVals=[],selected=this.getDisplayableSelectedDescriptors();for(var i=0;i<selected.length;i++){selectedVals.push(selected[i].value())}return selectedVals},setSelected:function(descriptor){var instance=this,selectedItem=false,changed=false,$toSelect=this.$element.find("option").not(this._getExclusions()).filter(function(){return this.value===descriptor.value()});if(this.type==="single"){if(this.getValue()===descriptor.value()){return changed}$toSelect=$toSelect.first();this.$element.find("option:selected").not(this._getExclusions()).each(function(i,option){var currDescriptor=AJS.$(this).data("descriptor");if($toSelect[0]!==option){instance.setUnSelected(currDescriptor)}})}$toSelect.each(function(){var $this=AJS.$(this);selectedItem=true;changed=!$this.is(":selected");$this.attr("selected","selected").data("descriptor").selected(true)});if(!selectedItem){descriptor.selected(true);descriptor.removeOnUnSelect(true);var newOption=this._render("option",descriptor);newOption.attr("selected","selected");this.$element.append(newOption);changed=true}descriptor.highlighted(false);if(changed){this.$element.trigger("change",descriptor)}return changed},setAllSelected:function(){var instance=this;AJS.$(this.getDisplayableUnSelectedDescriptors()).each(function(){instance.setSelected(this)})},setAllUnSelected:function(){var instance=this;AJS.$(this.getDisplayableSelectedDescriptors()).each(function(){instance.setUnSelected(this)})},setUnSelected:function(descriptor){var instance=this,value=descriptor.value();this.$element.find("option:selected").not(this._getExclusions()).filter(function(){return AJS.$(this).attr("value")===value}).each(function(){var $this=AJS.$(this);$this.data("descriptor").selected(false);if(instance.options.removeOnUnSelect||$this.data("descriptor").removeOnUnSelect()){$this.remove()}else{$this.removeAttr("selected")}})},remove:function(descriptor){if(descriptor&&descriptor.model()){descriptor.model().remove()}},getDescriptor:function(value){var returnDescriptor;value=AJS.$.trim(value.toLowerCase());AJS.$.each(this.getAllDescriptors(false),function(e,descriptor){if(value===AJS.$.trim(descriptor.label().toLowerCase())||value===AJS.$.trim(descriptor.value().toLowerCase())){returnDescriptor=descriptor;return false}});return returnDescriptor},_parseOption:function(optionElem){var descriptor,icon,fallbackIcon;optionElem=AJS.$(optionElem);if(this.options.removeNullOptions&&this._hasNullValue(optionElem)){optionElem.remove();return null}icon=optionElem.attr("data-icon");fallbackIcon=optionElem.attr("data-fallback-icon");descriptor=new AJS.ItemDescriptor({styleClass:optionElem.prop("className"),value:optionElem.val(),invalid:optionElem.hasClass("invalid_sel"),fieldText:optionElem.attr("data-field-text"),title:optionElem.attr("title"),meta:optionElem.data("meta"),label:optionElem.attr("data-field-label")||AJS.$.trim(optionElem.text()),icon:icon?icon:optionElem.css("backgroundImage").replace(/url\(['"]?(.*?)['"]?\)/,"$1"),fallbackIcon:fallbackIcon?fallbackIcon:"none",selected:optionElem.prop("selected"),removeOnUnSelect:!!optionElem.data("remove-on-unselect"),model:optionElem});optionElem.data("descriptor",descriptor);return descriptor},_hasNullValue:function(optionElement){return optionElement.val()<0},_parseDescriptors:function(){var instance=this,items=this.$element.children();function parseOptGroup(optionGroup){var properties={label:optionGroup.attr("label"),placement:optionGroup.attr("data-placement"),footerText:optionGroup.attr("data-footer-text"),styleClass:optionGroup.prop("className"),model:optionGroup,items:retrieveAvailableOptions(optionGroup)};var weight=optionGroup.data("weight");if(weight){properties.weight=+weight}optionGroup.data("descriptor",new AJS.GroupDescriptor(properties))}function retrieveAvailableOptions(parent){var availableOptionElems=AJS.$("option",parent),arr=[];AJS.$.each(availableOptionElems,function(){arr.push(instance._parseOption(this))});return arr}items.each(function(i){var item=items.eq(i);if(item.is("optgroup")){parseOptGroup(item)}else{if(item.is("option")){if(item.attr("data-placeholder")){instance.placeholder=item.text();item.remove()}else{instance._parseOption(item)}}}})},getPlaceholder:function(){return this.placeholder},_getExclusions:function(){return".free-input"},getValue:function(){if(this.type==="single"){return this.$element.val()&&this.$element.val()[0]}else{return this.$element.val()}},getDisplayableSelectedDescriptors:function(){var descriptors=[];this.$element.find("option:selected").not(this._getExclusions()).each(function(){descriptors.push(AJS.$.data(this,"descriptor"))});return descriptors},getDisplayableUnSelectedDescriptors:function(){var descriptors=[];this.$element.find("option").not(":selected").not(this._getExclusions()).each(function(){descriptors.push(AJS.$.data(this,"descriptor"))});return descriptors},getAllDescriptors:function(showGroups){var properties,descriptors=[];this.$element.children().each(function(){var descriptor,elem=AJS.$(this);if(elem.is("option")){if(elem.data("descriptor")){descriptors.push(elem.data("descriptor"))}}else{if(elem.is("optgroup")){if(showGroups!==false){properties=AJS.copyObject(elem.data("descriptor").allProperties(),false);properties.items=[];descriptor=new AJS.GroupDescriptor(properties);descriptors.push(descriptor)}elem.children("option").each(function(){var elem=AJS.$(this);var itemDescriptor=elem.data("descriptor");if(itemDescriptor){if(showGroups!==false){descriptor.addItem(itemDescriptor)}else{descriptors.push(itemDescriptor)}}})}}});return descriptors},clearUnSelected:function(){this.$element.find("option:not(:selected)").not(this._getExclusions()).remove()},getUnSelectedDescriptors:function(){var instance=this,descriptors=[],selectedValues={},addedValues={};function isValid(descriptor){var descriptorVal=descriptor.value().toLowerCase();if(!selectedValues[descriptorVal]&&(!addedValues[descriptorVal]||descriptor.allowDuplicate()!==false)){addedValues[descriptorVal]=true;return true}return false}var selectedDescriptors=this.getDisplayableSelectedDescriptors();AJS.$.each(selectedDescriptors,function(i,descriptor){selectedValues[descriptor.value().toLowerCase()]=true});var selectChildren=this.$element.children();selectChildren.each(function(){var descriptor,properties,elem=AJS.$(this);if(elem.is("option")&&!this.selected){descriptor=AJS.$.data(this,"descriptor");if(isValid(descriptor)){descriptors.push(descriptor)}}else{if(elem.is("optgroup")){properties=AJS.copyObject(elem.data("descriptor").allProperties(),false);properties.items=[];descriptor=new AJS.GroupDescriptor(properties);descriptors.push(descriptor);elem.find("option").not(instance._getExclusions()).each(function(option){if(option.selected){return }var itemDescriptor=AJS.$.data(this,"descriptor");if(isValid(itemDescriptor)){descriptor.addItem(itemDescriptor)}})}}});return descriptors},_renders:{option:function(descriptor){var label=descriptor.label();var text=descriptor.fieldText()||label;var option=new Option(text,descriptor.value());var $option=AJS.$(option);var iconUrl=descriptor.icon();option.title=descriptor.title();if(text!=label){$option.data("field-label",label)}if(descriptor.selected()){$option.attr("selected","selected")}AJS.$.data(option,"descriptor",descriptor);descriptor.model($option);if(iconUrl){$option.css("backgroundImage","url("+iconUrl+")")}return $option},optgroup:function(descriptor){var elem=AJS.$("<optgroup />").addClass(descriptor.styleClass()).attr("label",descriptor.label());descriptor.model(elem);elem.data("descriptor",descriptor);if(descriptor.id()){elem.attr("id",descriptor.id())}return elem}}});