(function($){JIRA.SmartAjax.showWebSudoDialog=function(options){var context=options.context||this;var dialog=new JIRA.FormDialog({id:"smart-websudo",type:"ajax",ajaxOptions:{url:contextPath+"/secure/admin/WebSudoAuthenticate!default.jspa?close=true"},submitHandler:function(e,closeCallback){e.preventDefault();var form=$(e.target);JIRA.SmartAjax.makeRequest({url:form.attr("action"),data:form.serialize(),type:"POST",complete:function(xhr){if(xhr.getResponseHeader("X-Atlassian-WebSudo")==="Has-Authentication"){if($.isFunction(options.success)){options.success.call(context,function(){closeCallback();dialog.hide()})}else{closeCallback();dialog.hide()}}else{dialog._setContent(xhr.responseText,true)}}})}});if($.isFunction(options.cancel)){$(dialog).one("Dialog.hide",function(e,el,reason){if(reason==JIRA.Dialog.HIDE_REASON.cancel||reason==JIRA.Dialog.HIDE_REASON.escape){e=$.Event();(options.cancel.call(context,e)===false||!e.isDefaultPrevented())&&AJS.reloadViaWindowLocation(el.find(".cancel").attr("href"))}})}dialog.show()};JIRA.SmartAjax.handleWebSudoError=function(ajaxOptions,dialogOptions,xhr,statusText,smartAjaxResult){var newOptions={success:function(closeFunction){if(dialogOptions&&$.isFunction(dialogOptions.success)){dialogOptions.success.apply(this,arguments)}else{closeFunction()}JIRA.SmartAjax.makeRequest(ajaxOptions)},cancel:function(){$.isFunction(ajaxOptions.complete)&&ajaxOptions.complete.call(this,xhr,statusText,smartAjaxResult);dialogOptions&&$.isFunction(dialogOptions.cancel)&&dialogOptions.cancel.apply(this,arguments)},context:this};JIRA.SmartAjax.showWebSudoDialog(newOptions)};JIRA.SmartAjax.makeWebSudoRequest=function(ajaxOptions,dialogOptions){var ourAjaxOptions=$.extend({},ajaxOptions);var suppressComplete=false;var deferred=$.Deferred();var errorHandler=function(xhr,statusText,errorThrown,smartAjaxResult){if(xhr.status===401&&xhr.responseText.match(/websudo/i)){suppressComplete=true;JIRA.SmartAjax.handleWebSudoError(ourAjaxOptions,dialogOptions,xhr,statusText,smartAjaxResult)}else{deferred.rejectWith(this,arguments);$.isFunction(ajaxOptions.error)&&ajaxOptions.error.apply(this,arguments)}};var completeHandler=function(){!suppressComplete&&$.isFunction(ajaxOptions.complete)&&ajaxOptions.complete.apply(this,arguments);suppressComplete=false};var successHandler=function(){deferred.resolveWith(this,arguments);$.isFunction(ajaxOptions.success)&&ajaxOptions.success.apply(this,arguments)};ourAjaxOptions.error=errorHandler;ourAjaxOptions.complete=completeHandler;ourAjaxOptions.success=successHandler;JIRA.SmartAjax.makeRequest(ourAjaxOptions);return deferred.promise()}})(AJS.$);