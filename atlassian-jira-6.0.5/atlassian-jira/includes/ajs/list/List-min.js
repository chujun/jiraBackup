AJS.List=AJS.Control.extend({init:function(options){options=options||{};if(options){this.options=AJS.$.extend(true,this._getDefaultOptions(options),options)}else{this.options=this._getDefaultOptions(options)}this._renders=jQuery.extend({},this._renders,this.options.renderers);this.disabled=true;this.reset();var instance=this;if(this.options.selectionHandler){this.$container.delegate(this.options.itemSelector,this.options.selectionEvent,function(e){instance.options.selectionHandler.call(instance,e)})}this.motionDetector.wait();this.$container.delegate(this.options.itemSelector,"mousemove",function(){if(!instance.disabled&&(instance.motionDetector.moved||AJS.isSelenium())){instance.index=AJS.$.inArray(this,instance.$visibleItems);instance.focus(true)}})},_getDefaultOptions:function(){return{selectionEvent:"click",delegateTarget:document,matchingStrategy:"(^|.*?(\\s+|\\())({0})(.*)",itemSelector:"li.aui-list-item",hasLinks:true,stallEventBind:true}},index:0,moveToFirst:function(){if(this.$visibleItems.length>0){this.index=0;this.focus()}},moveToNext:function(){if(this.index<this.maxIndex){++this.index;this.focus()}else{if(this.$visibleItems.length>1){this.index=0;this.focus()}}},container:function(container){if(container){this.$container=AJS.$(container);this.containerSelector=container}else{return this.$container}},getItemsByDescriptor:function(descriptorToMatch){var $matches=AJS.$();this.$container.find(this.options.itemSelector).each(function(){var descriptor=AJS.$.data(this,"descriptor");if(descriptor&&descriptor.value()===descriptorToMatch.value()){$matches=$matches.add(this)}});return $matches},scrollContainer:function(){return(this.options.scrollContainer)?this.$container.find(this.options.scrollContainer):this.$container.parent()},_isScrollConstrained:function(){var scrollContainer=this.scrollContainer()[0];return scrollContainer.clientHeight<scrollContainer.scrollHeight},moveToPrevious:function(){if(this.index>0){--this.index;this.focus()}else{if(this.$visibleItems.length>0){this.index=this.$visibleItems.length-1;this.focus()}}},scrollActiveItemIntoView:function(){var $activeItem=this.$visibleItems.filter(".active");var $scrollContainer=this.scrollContainer();var scrollTop=$scrollContainer.scrollTop();if($activeItem.length===0){return }if(!this._isScrollConstrained()){$activeItem.scrollIntoView({callback:AJS.$.proxy(this.motionDetector,"wait")});return }if($activeItem.closest($scrollContainer).length===0){return }if($activeItem.is($scrollContainer.find(this.items).first())){this._scrollContainerTo(0);return }var roomAbove=$activeItem.offset().top-$scrollContainer.offset().top;var roomBelow=$scrollContainer.outerHeight()-$activeItem.outerHeight()-roomAbove;if(roomAbove>=0){if(roomBelow<0){this._scrollContainerTo(scrollTop-roomBelow)}}else{this._scrollContainerTo(scrollTop+roomAbove)}},_scrollContainerTo:function(scrollTop){var $scrollContainer=this.scrollContainer();if($scrollContainer.scrollTop()!==scrollTop){this.motionDetector.unbind();this.motionDetector.wait();$scrollContainer.scrollTop(scrollTop)}},focus:function(noScroll){this.$visibleItems.removeClass("active");var $target=this.$visibleItems.eq(this.index);$target.addClass("active");this.lastFocusedItemDescriptor=$target.data("descriptor");if(!noScroll){this.scrollActiveItemIntoView()}},motionDetector:new JIRA.Mouse.MotionDetector(),disable:function(){if(this.disabled){return }this._unassignEvents("delegateTarget",this.options.delegateTarget);this.disabled=true;this.lastFocusedItemDescriptor=null},enable:function(){var instance=this;if(!instance.disabled){return }if(this.options.stallEventBind){window.setTimeout(function(){instance._assignEvents("delegateTarget",instance.options.delegateTarget)},0)}else{instance._assignEvents("delegateTarget",instance.options.delegateTarget)}instance.disabled=false;this._scrollContainerTo(0)},getFocused:function(){return this.$visibleItems.filter(".active")},reset:function(index){this.$container=AJS.$(this.options.containerSelector);this.items=AJS.$(this.options.itemSelector,this.$container).not(".no-suggestions");this.$visibleItems=this._computeVisibleItems();this.groups=AJS.$(this.options.groupSelector,this.$container);this.maxIndex=this.$visibleItems.length-1;this.index=this.$visibleItems[index]?index:0;this.focus(true)},_computeVisibleItems:function(){return this.items.not(".hidden, .disabled")},selectValue:function(value){var matchedItem=this.$container.find(this.options.itemSelector).filter(function(){return AJS.$(this).parent().data("descriptor").value()==value});if(!matchedItem.length){AJS.log("WARN: No List item found with Decriptor value '"+value+"'")}matchedItem.click()},_getLinkFromItem:function(item){var link;item=AJS.$(item);if(item.is("a")){link=item}else{link=item.find("a")}return link},_makeResultDiv:function(data,query){var $fixedContainer=AJS.$('<div class="aui-list-fixed">'),$resultsContainer=AJS.$('<div class="aui-list-scroll" tabindex="-1">'),instance=this,ungrouped=[];function appendUngrouped(){if(ungrouped.length>0){$resultsContainer.append(instance._generateUngroupedOptions(ungrouped,query));ungrouped=[]}}AJS.$.each(data,function(i,descriptor){var $container,$optgroup;if(descriptor instanceof AJS.GroupDescriptor){appendUngrouped();$container=(descriptor.placement()==="fixed")?$fixedContainer:$resultsContainer;$optgroup=instance._generateOptGroup(descriptor,query);$container.append($optgroup)}else{if(descriptor instanceof AJS.ItemDescriptor){ungrouped.push(descriptor)}}});appendUngrouped();if($fixedContainer.children().length===0){return $resultsContainer}return $fixedContainer.add($resultsContainer)},_addResultToContainer:function($result){if($result.not(".aui-list-fixed").find(this.options.itemSelector).length===0){var $scrollContainer=this.$container.find(".aui-list-scroll");if($scrollContainer.length==0){$scrollContainer=AJS.$('<div class="aui-list-scroll" tabindex="-1">').appendTo(this.$container)}$scrollContainer.html(this._render("noSuggestion"))}else{$result.find("ul:last").addClass("aui-last");this.$container.html($result)}},generateListFromJSON:function(data,query){this.suggestions=0;this.exactMatchIndex=-1;this.lastFocusedIndex=-1;this.lastQuery=query;var $result=this._makeResultDiv(data,query);this.$container.hide();this._addResultToContainer($result,query);this.$container.show();var indexToHighlight=this.exactMatchIndex>=0?this.exactMatchIndex:this.lastFocusedIndex;this.reset(indexToHighlight)},_generateOption:function(item,query,labelRegex){var replacementText;if(!item.highlighted()&&labelRegex&&labelRegex.test(item.label())){replacementText=item.label().replace(labelRegex,function(_,prefix,spaceOrParenthesis,match,suffix){var div=AJS.$("<div>");prefix&&div.append(AJS.$("<span>").text(prefix));div.append(AJS.$("<em>").text(match));suffix&&div.append(AJS.$("<span>").text(suffix));return div.html()})}if(this.exactMatchIndex<0){var itemValue=AJS.$.trim(item.label()).toLowerCase();if(!item.noExactMatch()&&itemValue===AJS.$.trim(query).toLowerCase()){this.exactMatchIndex=this.suggestions}else{if(this.lastFocusedIndex<0&&this.lastFocusedItemDescriptor&&itemValue===AJS.$.trim(this.lastFocusedItemDescriptor.label()).toLowerCase()){this.lastFocusedIndex=this.suggestions}}}this.suggestions++;return this._render("suggestion",item,replacementText)},_filterOptions:function(options,regexEscapedQuery,labelRegex){if(!regexEscapedQuery){return options}var filtered=[],keywordsRegex=new RegExp(AJS.format(".*{0}.*",regexEscapedQuery),"i");for(var i=0,len=options.length;i<len;i++){var item=this._filterOption(options[i],keywordsRegex,labelRegex);if(item){filtered.push(item)}}return filtered},_filterOption:function(item,keywordsRegex,labelRegex){var result;if(item.highlighted()){result=item}else{if(labelRegex.test(item.label())){result=item}else{if(item.keywords()){var matchedKeywords=[];var keywordString=""+item.keywords(),keywords=keywordString.split(",");for(var j=0;j<keywords.length;j++){var keyword=keywords[j];if(keywordsRegex.test(keyword)){matchedKeywords.push(keyword)}}if(matchedKeywords.length){item.labelSuffix(" "+matchedKeywords.join(", "));result=item}}}}return result},_addOptionsToContainer:function(options,$container,query,labelRegex){var instance=this,maxInlineResultsDisplayed=this.options.maxInlineResultsDisplayed,hasSuggestion=false,suggestions=[];for(var i=0,len=options.length;i<len;i++){var option=options[i];if(!maxInlineResultsDisplayed||i<maxInlineResultsDisplayed||!query){var $suggestion=instance._generateOption(option,query,labelRegex);if($suggestion){hasSuggestion=true;suggestions.push($suggestion[0])}}else{suggestions.push(instance._render("tooManySuggestions",options.length-i)[0]);break}}$container.html(AJS.$(suggestions));return hasSuggestion},_filterAndAddOptions:function(options,container,query){var regexEscapedQuery,labelRegex;if(query){regexEscapedQuery=RegExp.escape(query);labelRegex=new RegExp(AJS.format(this.options.matchingStrategy,regexEscapedQuery),"i");options=this._filterOptions(options,regexEscapedQuery,labelRegex)}if(this.options.maxResultsDisplayedPerGroup){options=options.slice(0,this.options.maxResultsDisplayedPerGroup)}return this._addOptionsToContainer(options,container,query,labelRegex)},_generateUngroupedOptions:function(options,query){var $container=this._render("ungroupedSuggestions");var optionsAdded=this._filterAndAddOptions(options,$container,query);if(optionsAdded){return $container}},_generateOptGroup:function(groupDescriptor,query){var res=AJS.$(),optContainer=this._render("suggestionGroup",groupDescriptor),options=groupDescriptor.items(),optionsAdded;optionsAdded=this._filterAndAddOptions(options,optContainer,query);if(!optionsAdded){return }if(groupDescriptor.label()&&groupDescriptor.showLabel()!==false){res=res.add(this._render("suggestionGroupHeading",groupDescriptor))}if(groupDescriptor.footerText()){optContainer.append(this._render("suggestionsGroupFooter",groupDescriptor.footerText()))}else{if(groupDescriptor.footerHtml()){optContainer.append(groupDescriptor.footerHtml())}}if(groupDescriptor.actionBarHtml()){optContainer.prepend(groupDescriptor.actionBarHtml())}res=res.add(optContainer);return res},_events:{delegateTarget:{"aui:keydown":function(event){this._handleKeyEvent(event)}}},_renders:{suggestion:function(descriptor,replacementText){var idSuffix=descriptor.fieldText()||descriptor.label();var itemId=AJS.escapeHTML(AJS.$.trim(idSuffix.toLowerCase()).replace(/[\s\.]+/g,"-")),listElem=AJS.$('<li class="aui-list-item aui-list-item-li-'+itemId+'"><a class="aui-list-item-link"/></li>'),linkElem=listElem.children();if(descriptor.selected()){listElem.addClass("aui-checked")}if(this.options.hasLinks){linkElem.attr("href",descriptor.href()||"#")}if(descriptor.styleClass()){linkElem.addClass(descriptor.styleClass())}if(replacementText){linkElem.html(replacementText)}else{if(descriptor.html()){linkElem.html(descriptor.html())}else{linkElem.text(descriptor.label())}}if(descriptor.labelSuffix()){var suffixSpan=AJS.$("<span class='aui-item-suffix' />").text(descriptor.labelSuffix());linkElem.append(suffixSpan)}if(descriptor.icon()&&descriptor.icon()!=="none"){linkElem.addClass("aui-iconised-link").prepend('<img class="icon" src="'+descriptor.icon()+'" alt="" />')}if(descriptor.title()){linkElem.prop("title",descriptor.title())}else{linkElem.prop("title",linkElem.text())}listElem.data("descriptor",descriptor);return listElem},noSuggestion:function(){return AJS.$("<li class='no-suggestions'>"+AJS.I18n.getText("common.concepts.no.matches")+"</li>")},tooManySuggestions:function(suggestionCount){return AJS.$("<li class='no-suggestions'>"+AJS.I18n.getText("common.concepts.too.many.matches",suggestionCount)+"</li>")},ungroupedSuggestions:function(){return AJS.$("<ul>")},suggestionGroup:function(descriptor){return AJS.$("<ul class='aui-list-section' />").attr("id",descriptor.label().replace(/\s/g,"-").toLowerCase()).addClass(descriptor.styleClass()).data("descriptor",descriptor)},suggestionGroupHeading:function(descriptor){var elem=AJS.$("<h5 />").text(descriptor.label()).addClass(descriptor.styleClass()).data("descriptor",descriptor);if(descriptor.description()){AJS.$("<span class='aui-section-description' />").text(" ("+descriptor.description()+")").appendTo(elem)}return elem},suggestionsGroupFooter:function(text){return AJS.$("<li class='aui-list-section-footer' />").text(text)}},_acceptSuggestion:function(item){if(!item instanceof AJS.$){item=AJS.$(item)}var linkNode=this._getLinkFromItem(item);if(linkNode.length){var event=new jQuery.Event("click");linkNode.trigger(event,[linkNode]);if(!event.isDefaultPrevented()){window.location.href=linkNode.attr("href")}}},getAllItems:function(){return this.$container.find(this.options.itemSelector)},_acceptUserInput:function($field){$field.triggerHandler("blur")},_handleSectionByKeyboard:function(e){var $focusedItem=this.getFocused();var $field=AJS.$(e.target);if($focusedItem.length===0){return }if(this._latestQuery&&AJS.$.trim($field.val())!==this._latestQuery){var inputWords=$field.val().toLowerCase().match(/\S+/g);if(inputWords){var html=this.lastFocusedItemDescriptor&&this.lastFocusedItemDescriptor.html();var $item=html?AJS.$("<div>").html(html):$focusedItem;var matches=[];$item.find("em,b").each(function(){var $match=AJS.$(this),nextText=AJS.$($match.attr("nextSibling")).text().toLowerCase().match(/^\S*/)[0];AJS.$.each($match.text().toLowerCase().match(/\S+/g),function(i,match){matches.push(match+nextText)})});for(var i=0;i<inputWords.length;i++){var word=inputWords[i];var n=word.length;var hasMatch=false;for(var j=0;j<matches.length;j++){if(matches[j].slice(0,n)===word){hasMatch=true;break}}if(!hasMatch){this._acceptUserInput($field);return }}}}this.scrollActiveItemIntoView();if(this.options.selectionHandler&&!this.options.selectionHandler.call(this,e)){return }this._acceptSuggestion($focusedItem)},_isValidInput:function(){return !this.disabled&&this.$container.is(":visible")},keys:{"Down":function(event){this.moveToNext();event.preventDefault()},"Up":function(event){this.moveToPrevious();event.preventDefault()},"Return":function(event){this._handleSectionByKeyboard(event);event.preventDefault()}}});