/* module-key = 'jira.webresources:inline-layer', location = '/includes/ajs/layer/InlineLayer.js' */
AJS.InlineLayer=AJS.Control.extend({CLASS_SIGNATURE:"AJS_InlineLayer",SCROLL_HIDE_EVENT:"scroll.hide-dropdown",init:function(options){var instance=this;if(!(options instanceof AJS.InlineLayer.OptionsDescriptor)){this.options=new AJS.InlineLayer.OptionsDescriptor(options)}else{this.options=options}this.offsetTarget(this.options.offsetTarget());this.contentRetriever=this.options.contentRetriever();AJS.$.extend(this,this.options.positioningController());if(!(this.contentRetriever instanceof AJS.ContentRetriever)){throw new Error("AJS.InlineLayer: Failed construction, Content retriever does not implement interface "+"[AJS.ContentRetrieverInterface]")}this.contentRetriever.startingRequest(function(){instance._showLoading()});this.contentRetriever.finishedRequest(function(){instance._hideLoading()});if(this.contentRetriever.failedRequest){this.contentRetriever.failedRequest(function(){instance.onerror()})}this.$layer=this._render("layer",this.options.alignment())},content:function(arg){var instance=this;if(AJS.$.isFunction(arg)){this.contentRetriever.content(function(content){instance.$content=content.removeClass("hidden");arg.call(instance)})}else{return this.$content}},offsetTarget:function(){var $offsetTarget=this.options.offsetTarget();if(AJS.$.isFunction($offsetTarget)){$offsetTarget=$offsetTarget()}return $offsetTarget},contentChange:function(callback){var instance=this;if(AJS.$.isFunction(callback)){if(!this.contentChangeCallback){this.contentChangeCallback=[]}this.contentChangeCallback.push(callback)}else{if(!callback){this.trigger("contentChanged",[this]);this.setWidth(this.options.width());if(this.contentChangeCallback){AJS.$.each(this.contentChangeCallback,function(i,callback){callback(instance)})}}}},onhide:function(callback){var instance=this;if(AJS.$.isFunction(callback)){if(!this.hideCallback){this.hideCallback=[]}this.hideCallback.push(callback)}else{if(!callback&&this.hideCallback){AJS.$.each(this.hideCallback,function(i,callback){callback(instance)})}}},onerror:function(callback){var instance=this;if(AJS.$.isFunction(callback)){if(!this.errorCallback){this.errorCallback=[]}this.errorCallback.push(callback)}else{if(!callback&&this.errorCallback){AJS.$.each(this.errorCallback,function(i,callback){callback(instance)})}}},layer:function(layer){if(layer){this.$layer=layer}else{return this.$layer}},placeholder:function(placeholder){if(placeholder){this._throwReadOnlyError("placeholder")}else{return this.$placeholder}},isVisible:function(visible){if(typeof visible!=="undefined"){this._throwReadOnlyError("visible")}return this.visible},scrollableContainer:function(scrollableContainer){if(scrollableContainer){this._throwReadOnlyError("scrollableContainer")}return this.$scrollableContainer},isInitialized:function(initialised){if(initialised){this._throwReadOnlyError("initialized")}return this.initialized},hide:function(reason,e){var event;var target=e&&e.target;if(!this.isVisible()){return false}event=AJS.$.Event(AJS.InlineLayer.EVENTS.beforeHide);this.trigger(event,[this.layer(),reason,this.options.id,target]);JIRA.trigger(event,[this.layer(),reason,this.options.id,target]);if(!event.isDefaultPrevented()){this.visible=false;this._makeInactiveAndHideLayer();var positionController=this;setTimeout(function(){positionController.appendToPlaceholder()},0);this._unbindEvents();this.onhide();this.trigger("hideLayer",[this]);AJS.$(document).trigger("hideLayer",[this.CLASS_SIGNATURE,this]);this.trigger(AJS.InlineLayer.EVENTS.hide,[this.layer(),reason,this.options.id]);JIRA.trigger(AJS.InlineLayer.EVENTS.hide,[this.layer(),reason,this.options.id]);AJS.InlineLayer.current=null}},_makeInactiveAndHideLayer:function(){this.layer().removeClass(AJS.ACTIVE_CLASS).hide();this.offsetTarget().removeClass(AJS.ACTIVE_CLASS)},refreshContent:function(callback){var instance=this;this.content(function(){if(this.layer().has(this.content()).length===0){this.layer().html(this.content())}if(AJS.$.isFunction(callback)){callback.call(instance)}this.contentChange()})},show:function(){var instance=this,event;if(this.isVisible()){return }event=AJS.$.Event(AJS.InlineLayer.EVENTS.beforeShow);this.trigger(event,[this.layer(),this.options.id]);JIRA.trigger(event,[this.layer(),this.options.id]);if(!event.isDefaultPrevented()){if(!this.isInitialized()){this._lazyInit(function(){instance._showContent()})}else{if(this.contentRetriever.cache()===false){this.refreshContent(function(){instance._showContent()})}else{instance._showContent()}}}},_showContent:function(){if(this.offsetTarget().is(":visible")){this._show()}else{this._makeInactiveAndHideLayer()}},toggle:function(shouldShow){if(shouldShow==null){shouldShow=!this.isVisible()}if(shouldShow){this.show()}else{this.hide(AJS.HIDE_REASON.toggle)}},setPosition:function(){var positioning,$window=AJS.$(window);if(!this.isInitialized()||!this.offsetTarget()||this.offsetTarget().length===0){return }var offsetTargetLeft=this.offsetTarget().offset().left;var layerWidth=this.layer().width();var hasSpaceOnRight=offsetTargetLeft+layerWidth<$window.width()+$window.scrollLeft();var hasSpaceOnLeft=offsetTargetLeft+this.offsetTarget().outerWidth()-layerWidth>$window.scrollLeft();if(this.options.alignment()===AJS.RIGHT){if(hasSpaceOnLeft||!hasSpaceOnRight){positioning=this.right()}else{positioning=this.left()}}else{if(this.options.alignment()===AJS.LEFT){if(hasSpaceOnRight||!hasSpaceOnLeft){positioning=this.left()}else{positioning=this.right()}}else{if(this.options.alignment()===AJS.INTELLIGENT_GUESS){if((offsetTargetLeft+(this.offsetTarget().width()/2))>$window.width()/2){positioning=this.right()}else{positioning=this.left()}}}}this.trigger("setLayerPosition",[positioning,this]);if(this.options.properties.setMaxHeightToWindow||(this.options.properties.setMaxHeightToWindow!==false&&AJS.$(".aui-blanket").is(":visible"))){var scrollLeft=$window.scrollLeft();if(scrollLeft>0){positioning.left-=scrollLeft}var $fixedParents=this.fixedParent();var scrollTop;if($fixedParents.size()){scrollTop=0}else{scrollTop=$window.scrollTop()}positioning.maxHeight=$window.height()-positioning.top+scrollTop-this.options.cushion()}positioning.minHeight=this.options.properties.minHeight;this.layer().css(positioning)},setOverflowAndHeight:function(){if(this.options.properties.maxInlineResultsDisplayed){this.layer().addClass("limited")}},fixedParent:function(){return this.offsetTarget().parents().filter(function(){return jQuery(this).css("position")==="fixed"})},setWidth:function(width){this.layer().width(width)},_lazyInit:function(callback){if(this.initializing){return }this.initializing=true;this.refreshContent(function(){var instance=this;this.initializing=false;this.initialized=true;this.layer().insertAfter(this.offsetTarget());if(this._supportsBoxShadow()){this.layer().addClass(AJS.BOX_SHADOW_CLASS)}this.$placeholder=AJS.$("<div class='ajs-layer-placeholder' />").insertAfter(this.offsetTarget());this.$scrollableContainer=this.offsetTarget().closest(this.options.hideOnScroll());this.rebuilt(function(layer){instance.layer(layer)});callback()})},_show:function(){if(AJS.InlineLayer.current){AJS.InlineLayer.current.hide()}this.visible=true;this.content().show();this.appendToBody();this.layer().addClass(AJS.ACTIVE_CLASS);this.offsetTarget().addClass(AJS.ACTIVE_CLASS);this.layer().show();this.setWidth(this.options.width());this.setPosition();this.setOverflowAndHeight();this._bindEvents();if(!AJS.dim.dim){this.scrollTo()}AJS.InlineLayer.current=this;this.trigger("showLayer",[this]);AJS.$(document).trigger("showLayer",[this.CLASS_SIGNATURE,this]);this.trigger(AJS.InlineLayer.EVENTS.show,[this.layer(),this.options.id]);JIRA.trigger(AJS.InlineLayer.EVENTS.show,[this.layer(),this.options.id])},_hideLoading:function(){this.$layer.removeClass(AJS.LOADING_CLASS);this.offsetTarget().removeClass(AJS.LOADING_CLASS)},_showLoading:function(){this.$layer.addClass(AJS.LOADING_CLASS);this.offsetTarget().addClass(AJS.LOADING_CLASS)},_unbindEvents:function(){this.$scrollableContainer.unbind(this.SCROLL_HIDE_EVENT);this._unassignCustomEvents();this._unassignEvents("container",document);this._unassignEvents("win",window)},_bindEvents:function(){var instance=this;this.$scrollableContainer.one(this.SCROLL_HIDE_EVENT,function(){instance.hide()});this._assignCustomEvents();this._assignEvents("container",document);this._assignEvents("win",window)},_assignCustomEvents:function(){var customEvents=this.options.customEvents();if(!customEvents){return }this._unassignCustomEvents();for(var target in customEvents){for(var eventType in customEvents[target]){AJS.$(target).on(eventType,this._getCustomEventsDispatcher(target,eventType,customEvents))}}},_unassignCustomEvents:function(){var customEvents=this.options.customEvents();if(!customEvents){return }for(var target in customEvents){for(var eventType in customEvents[target]){AJS.$(target).off(eventType,this._getCustomEventsDispatcher(target,eventType,customEvents))}}},_getCustomEventsDispatcher:function(target,eventType,events){var group="custom";var ns=group+"/"+target+"/"+eventType;if(!this._dispatchers){this._dispatchers={}}if(!this._dispatchers[ns]){var instance=this;var handler=events[target][eventType];this._dispatchers[ns]=function(event){return handler.call(instance,event,AJS.$(this))}}return this._dispatchers[ns]},_validateClickToClose:function(e){if(e.target===this.offsetTarget()[0]){return false}else{if(e.target===this.layer()[0]){return false}else{if(this.offsetTarget().has(e.target).length>0){return false}else{if(this.layer().has(e.target).length>0){return false}}}}return true},"keys":{Esc:function(e){this.hide(AJS.HIDE_REASON.escPressed,e)}},_events:{container:{"aui:keydown":function(event){this._handleKeyEvent(event)},click:function(e){if(this._validateClickToClose(e)){this.hide(AJS.HIDE_REASON.clickOutside,e)}}},win:{resize:function(){this.setPosition()},scroll:function(){this.setPosition()}}},_renders:{layer:function(){return AJS.$("<div />").addClass("ajs-layer "+(this.options.styleClass()||""))}}});AJS.InlineLayer.EVENTS={beforeHide:"InlineLayer.beforeHide",hide:"InlineLayer.hide",beforeShow:"InlineLayer.beforeShow",show:"InlineLayer.show"};JIRA.bind(AJS.InlineLayer.EVENTS.beforeHide,function(e){if(typeof Calendar!=="undefined"&&Calendar.current){e.preventDefault()}});
/* module-key = 'jira.webresources:inline-layer', location = '/includes/ajs/layer/InlineLayer.OptionsDescriptor.js' */
AJS.InlineLayer.OptionsDescriptor=AJS.Descriptor.extend({init:function(properties){this._super(properties);if(!this.contentRetriever()){if(this.ajaxOptions()){this.contentRetriever(new AJS.AjaxContentRetriever(this.ajaxOptions()))}else{if(AJS.$.isFunction(this.content())){this.contentRetriever(new AJS.DeferredContentRetriever(this.content()))}else{if(this.content()){this.contentRetriever(new AJS.DOMContentRetriever(this.content()))}else{throw new Error("AJS.InlineLayer.OptionsDescriptor: Expected either [ajaxOptions] or [contentRetriever] or [content] to be defined")}}}}if(!this.positioningController()){if(!AJS.params.ignoreFrame&&this._inIFrame()){this.positioningController(new AJS.InlineLayer.IframePositioning())}else{var $body=jQuery("body");var isBodyOverflowHidden=$body.css("overflow")==="hidden"||$body.css("overflowY")==="hidden";if(isBodyOverflowHidden){this.positioningController(new AJS.InlineLayer.WindowPositioning())}else{this.positioningController(new AJS.InlineLayer.StandardPositioning())}}}if(AJS.$.browser.msie&&AJS.$.browser.version<9&&this.positioningController().isOffsetIncludingScroll){this.positioningController().isOffsetIncludingScroll(false)}if(!this.offsetTarget()&&this.content() instanceof AJS.$){this.offsetTarget(this.content().prev())}},_inIFrame:function(){var parentWindow=window;try{while(parentWindow.parent.window!==parentWindow.window){parentWindow=parentWindow.parent;if(parentWindow.AJS){return true}}}catch(error){}return false},_getDefaultOptions:function(){return{alignment:AJS.INTELLIGENT_GUESS,hideOnScroll:".form-body",cushion:20,width:200}},positioningController:function(positioningController){if(positioningController){this.properties.positioningController=positioningController}else{return this.properties.positioningController}},ajaxOptions:function(ajaxOptions){if(ajaxOptions){this.properties.ajaxOptions=ajaxOptions}else{return this.properties.ajaxOptions}},content:function(content){if(content){content=AJS.$(content);if(content.length){this.properties.content=content}}else{if(this.properties.content&&(this.properties.content.length||AJS.$.isFunction(this.properties.content))){return this.properties.content}}},contentRetriever:function(contentRetriever){if(contentRetriever){this.properties.contentRetriever=contentRetriever}else{return this.properties.contentRetriever}},offsetTarget:function(offsetTarget){if(offsetTarget){offsetTarget=AJS.$(offsetTarget);if(offsetTarget.length){this.properties.offsetTarget=offsetTarget}}else{if(this.properties.offsetTarget&&(this.properties.offsetTarget.length||AJS.$.isFunction(this.properties.offsetTarget))){return this.properties.offsetTarget}}},cushion:function(cushion){if(cushion){this.properties.cushion=cushion}else{return this.properties.cushion}},styleClass:function(styleClass){if(styleClass){this.properties.styleClass=styleClass}else{return this.properties.styleClass}},hideOnScroll:function(hideOnScroll){if(hideOnScroll){this.properties.hideOnScroll=hideOnScroll}else{return this.properties.hideOnScroll}},alignment:function(alignment){if(alignment){this.properties.alignment=alignment}else{return this.properties.alignment}},width:function(width){if(width){this.properties.width=width}else{if(AJS.$.isFunction(this.properties.width)){return this.properties.width.call(this)}else{return this.properties.width}}},allowDownsize:function(allowDownsize){if(allowDownsize){this.properties.allowDownsize=allowDownsize}else{return this.properties.allowDownsize}},customEvents:function(customEvents){if(customEvents){this.properties.customEvents=customEvents}else{return this.properties.customEvents}}});
/* module-key = 'jira.webresources:inline-layer', location = '/includes/ajs/layer/InlineLayer.create.js' */
AJS.InlineLayer.create=function(options){var inlineLayers=[];if(options.content){options.content=AJS.$(options.content);AJS.$.each(options.content,function(){var instanceOptions=AJS.copyObject(options);instanceOptions.content=AJS.$(this);inlineLayers.push(new AJS.InlineLayer(instanceOptions))})}if(inlineLayers.length==1){return inlineLayers[0]}else{return inlineLayers}};
/* module-key = 'jira.webresources:inline-layer', location = '/includes/ajs/layer/InlineLayer.StandardPositioning.js' */
AJS.InlineLayer.StandardPositioning=Class.extend({init:function(){this.rebuiltCallbacks=[]},left:function(){var offset=this.offset();return{left:offset.left,top:offset.top+this.offsetTarget().outerHeight()}},right:function(){var offset=this.offset();return{left:offset.left-this.layer().outerWidth()+this.offsetTarget().outerWidth(),top:offset.top+this.offsetTarget().outerHeight()}},window:function(){return window},offset:function(){var offset=this.offsetTarget().offset();if(this.offsetTarget().hasFixedParent()){this.layer().css("position","fixed");offset.top=offset.top-AJS.$(window).scrollTop()}else{this.layer().css("position","absolute")}return offset},rebuilt:function(arg){var instance=this;if(AJS.$.isFunction(arg)){this.rebuiltCallbacks.push(arg)}else{AJS.$.each(this.rebuiltCallbacks,function(){this(instance.layer())})}},appendToBody:function(){this.layer().appendTo("body")},appendToPlaceholder:function(){this.layer().appendTo(this.$placeholder)},scrollTo:function(){}});AJS.InlineLayer.WindowPositioning=AJS.InlineLayer.StandardPositioning.extend({_calculateOverflow:function(offset){var isFixed=this.layer().css("position")==="fixed",layerBottom=offset.top+this.layer().outerHeight(true),windowHeight=jQuery(window).outerHeight(),windowScroll=jQuery(window).scrollTop();if(isFixed){return Math.max(0,layerBottom-windowHeight)}else{return Math.max(0,layerBottom-windowScroll-windowHeight)}},left:function(){var offset=this._super(),overflow=this._calculateOverflow(offset);if(overflow>0){offset.left+=this.offsetTarget().outerWidth();offset.top-=overflow}return offset},right:function(){var offset=this._super(),overflow=this._calculateOverflow(offset);if(overflow>0){offset.left-=this.offsetTarget().outerWidth();offset.top-=overflow}return offset}});
/* module-key = 'jira.webresources:inline-layer', location = '/includes/ajs/layer/InlineLayer.IframePositioning.js' */
AJS.InlineLayer.IframePositioning=AJS.InlineLayer.StandardPositioning.extend({offset:function(){var offsetInDocument=this._super(),iframeOffset=AJS.$("iframe[name="+window.name+"]",window.top.document.body).parent().offset(),topDocumentScrollTop=this._topDocumentScrollTop(),topDocumentScrollLeft=this._topDocumentScrollLeft(),iframeScrollTop=this._iframeScrollTop(),iframeScrollLeft=this._iframeScrollLeft(),scrollTopModifier=topDocumentScrollTop-iframeScrollTop,scrollLeftModifier=topDocumentScrollLeft-iframeScrollLeft;return{left:iframeOffset.left+offsetInDocument.left+scrollLeftModifier,top:iframeOffset.top+offsetInDocument.top+scrollTopModifier}},_topDocumentScrollTop:function(){return this.isOffsetIncludingScroll()?0:Math.max(window.top.document.body.scrollTop,window.top.document.documentElement.scrollTop)},_topDocumentScrollLeft:function(){return this.isOffsetIncludingScroll()?0:Math.max(window.top.document.body.scrollLeft,window.top.document.documentElement.scrollLeft)},_iframeScrollTop:function(){return this.isOffsetIncludingScroll()?2*Math.max(window.document.body.scrollTop,window.document.documentElement.scrollTop):0},_iframeScrollLeft:function(){return this.isOffsetIncludingScroll()?2*Math.max(window.document.body.scrollLeft,window.document.documentElement.scrollLeft):0},isOffsetIncludingScroll:function(offsetIncludingScroll){if(typeof this.offsetIncludingScroll==="undefined"){this.offsetIncludingScroll=true}if(typeof offsetIncludingScroll!=="undefined"){this.offsetIncludingScroll=offsetIncludingScroll}return this.offsetIncludingScroll},appendToBody:function(){window.top.jQuery("body").append(this.layer())},window:function(){return window.top},scrollTo:function(){}});if(AJS.$.browser.safari||(AJS.$.browser.msie&&AJS.$.browser.version<8)){AJS.InlineLayer.IframePositioning=AJS.InlineLayer.IframePositioning.extend({appendToBody:function(){var oldLayer=this.layer();this.layer(this._rebuildLayerInParent());window.top.jQuery("body").append(this.layer());oldLayer.remove();this.rebuilt()},appendToPlaceholder:function(){var oldLayer=this.layer();this.layer(this._rebuildLayerInIframe());this.layer().appendTo(this.placeholder());oldLayer.remove();this.rebuilt()},_rebuildLayerInParent:function(){return window.top.jQuery("<div class='ajs-layer'>"+this.layer().html()+"</div>")},_rebuildLayerInIframe:function(){return AJS.$("<div class='ajs-layer'>"+this.layer().html()+"</div>")}})}if(AJS.$.browser.mozilla){AJS.InlineLayer.IframePositioning=AJS.InlineLayer.IframePositioning.extend({appendToPlaceholder:function(){var $oldLayer=this.layer();this.layer($oldLayer.clone(true).appendTo(this.placeholder()));this.rebuilt();window.setTimeout(function(){$oldLayer.remove()},10)}})};
